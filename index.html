<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kalendarz przygotowaÅ„ â€“ Maja Matwiejczuk</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script type="module" defer>
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCnMfYLnkVcttfpjcfisGv1s-Nx-pL4jFk",
  authDomain: "maja2026-2ee26.firebaseapp.com",
  projectId: "maja2026-2ee26",
  storageBucket: "maja2026-2ee26.firebasestorage.app",
  messagingSenderId: "365178420968",
  appId: "1:365178420968:web:2081cdd7ae556d6eb6135d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========= DOM ========= */
const calendarEl = document.getElementById('calendar');
const titleEl = document.getElementById('title');
const dayBtn = document.getElementById('dayBtn');
const homeBtn = document.getElementById('homeBtn');
const countdownEl = document.getElementById('countdown');
const starsCounterEl = document.getElementById('starsCounter');

/* ========= DATA ========= */
let currentDate = new Date();
let currentView = 'month';

const mpStart = new Date(2026,1,28);
const mpEnd   = new Date(2026,2,8);

/* ========= HELPERS ========= */
function debounce(fn, delay=400){
  let t;
  return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); };
}
async function saveDay(key, obj){
  await setDoc(doc(db,'calendar',key), obj, {merge:true});
}
async function loadDay(key){
  const s = await getDoc(doc(db,'calendar',key));
  return s.exists()?s.data():{};
}

/* ========= LICZNIK GWIAZDEK ========= */
async function updateStarsCounter(){
  let earned = 0;
  const docs = await getDocs(collection(db,'calendar'));

  docs.forEach(d=>{
    const [y,m,dd] = d.id.split('-').map(Number);
    const date = new Date(y,m-1,dd);

    // LICZYMY OD POCZÄ„TKU KALENDARZA DO MP
    if(date <= mpEnd){
      earned += d.data().stars || 0;
    }
  });

  const totalDays =
    Math.floor((mpEnd - new Date(2025,11,1))/(1000*60*60*24)) + 1;

  starsCounterEl.textContent = `â­ Gwiazdki: ${earned}/${totalDays*5}`;
}

/* ========= COUNTDOWN ========= */
function updateCountdown(){
  const diff = Math.ceil((mpStart-new Date())/(1000*60*60*24));
  countdownEl.textContent =
    diff>0 ? `â³ Dni do Mistrzostw Polski: ${diff}` : `ğŸ† Mistrzostwa trwajÄ… lub zakoÅ„czone`;
}

/* ========= GWIAZDKI + IKONY ========= */
function starsIcons(key,data,el){
  const row=document.createElement('div'); row.className='row';

  const stars=document.createElement('div');
  for(let i=1;i<=5;i++){
    const s=document.createElement('span');
    s.textContent=data.stars>=i?'â˜…':'â˜†';
    s.style.color=data.stars>=i?'gold':'black';
    s.onclick=async()=>{
      const v=data.stars===i?0:i;
      await saveDay(key,{stars:v});
      updateStarsCounter();
      if(currentView==='month') renderMonth();
      if(currentView==='day') renderDay(currentDate);
    };
    stars.appendChild(s);
  }

  const icons=document.createElement('div');
  const map={trening:'ğŸ¯',turniej:'ğŸ†',analiza:'ğŸ§ ',regeneracja:'ğŸ˜´'};
  Object.keys(map).forEach(f=>{
    if(data[f]) icons.textContent+=map[f];
  });

  row.append(stars,icons);
  el.appendChild(row);
}

/* ========= WIDOK DNIA ========= */
async function renderDay(date){
  currentView='day';
  calendarEl.innerHTML='';
  calendarEl.style.gridTemplateColumns='1fr';

  const key=date.toISOString().slice(0,10);
  const data=await loadDay(key);

  titleEl.textContent=`Maja Matwiejczuk â€“ ${date.toLocaleDateString('pl-PL',{weekday:'long',day:'numeric',month:'long'})}`;

  const el=document.createElement('div'); el.className='day';
  el.innerHTML=`
    <textarea id="plan" placeholder="Plan dnia">${data.text||''}</textarea>
    <input id="link" placeholder="Link Lichess" value="${data.link||''}">
    <label><input id="coachDone" type="checkbox" ${data.coachDone?'checked':''}> Informacje od trenera wykonane</label>
    <textarea id="coachInfo" placeholder="Informacje od trenera">${data.coachInfo||''}</textarea>

    <div class="checks">
      <label><input type="checkbox" id="d_trening" ${data.trening?'checked':''}> ğŸ¯ Trening</label>
      <label><input type="checkbox" id="d_turniej" ${data.turniej?'checked':''}> ğŸ† Turniej</label>
      <label><input type="checkbox" id="d_analiza" ${data.analiza?'checked':''}> ğŸ§  Analiza</label>
      <label><input type="checkbox" id="d_regeneracja" ${data.regeneracja?'checked':''}> ğŸ˜´ Regeneracja</label>
    </div>
  `;

  const autosave=debounce(()=>saveDay(key,{
    text:el.querySelector('#plan').value,
    link:el.querySelector('#link').value,
    coachInfo:el.querySelector('#coachInfo').value,
    coachDone:el.querySelector('#coachDone').checked
  }));

  el.querySelectorAll('textarea,input').forEach(i=>i.oninput=autosave);

  ['trening','turniej','analiza','regeneracja'].forEach(f=>{
    el.querySelector('#d_'+f).onchange=e=>saveDay(key,{[f]:e.target.checked});
  });

  starsIcons(key,data,el);
  calendarEl.appendChild(el);
}

/* ========= MIESIÄ„C ========= */
async function renderMonth(){
  currentView='month';
  calendarEl.innerHTML='';
  calendarEl.style.gridTemplateColumns='repeat(7,1fr)';

  const y=currentDate.getFullYear(), m=currentDate.getMonth();
  titleEl.textContent=currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});

  const first=new Date(y,m,1).getDay()||7;
  const days=new Date(y,m+1,0).getDate();
  for(let i=1;i<first;i++) calendarEl.appendChild(document.createElement('div'));

  for(let d=1;d<=days;d++){
    const date=new Date(y,m,d);
    const key=date.toISOString().slice(0,10);
    const data=await loadDay(key);

    const el=document.createElement('div'); el.className='day';
    el.ondblclick=()=>renderDay(date);
    el.innerHTML=`<b>${d}</b>`;
    starsIcons(key,data,el);
    calendarEl.appendChild(el);
  }
}

/* ========= START ========= */
homeBtn.onclick=renderMonth;
dayBtn.onclick=()=>renderDay(currentDate);

window.onload=()=>{
  updateCountdown();
  updateStarsCounter();
  renderMonth();
};
</script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{padding:10px;display:flex;justify-content:space-between}
.calendar{display:grid;gap:8px;padding:10px}
.day{background:#fff;padding:8px;border-radius:8px;display:flex;flex-direction:column;gap:6px}
textarea{min-height:80px}
.row{display:flex;gap:10px;align-items:center}
.checks{display:flex;gap:10px;flex-wrap:wrap}
span{cursor:pointer;font-size:20px}
</style>
</head>

<body>
<header>
<h1 id="title">Kalendarz</h1>
<div>
<button id="homeBtn">MiesiÄ…c</button>
<button id="dayBtn">DzieÅ„</button>
</div>
</header>

<div id="countdown"></div>
<div id="starsCounter"></div>
<main id="calendar" class="calendar"></main>
</body>
</html>
