<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kalendarz przygotowa≈Ñ ‚Äì Maja Matwiejczuk</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCnMfYLnkVcttfpjcfisGv1s-Nx-pL4jFk",
  authDomain: "maja2026-2ee26.firebaseapp.com",
  projectId: "maja2026-2ee26",
  storageBucket: "maja2026-2ee26.firebasestorage.app",
  messagingSenderId: "365178420968",
  appId: "1:365178420968:web:2081cdd7ae556d6eb6135d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= DOM ================= */
const calendarEl = document.getElementById('calendar');
const titleEl = document.getElementById('title');
const monthBtn = document.getElementById('monthBtn');
const weekBtn = document.getElementById('weekBtn');
const dayBtn = document.getElementById('dayBtn');
const homeBtn = document.getElementById('homeBtn');
const countdownEl = document.getElementById('countdown');
const starsCounterEl = document.getElementById('starsCounter');

/* ================= DATA ================= */
let currentDate = new Date();
let currentView = 'month';

const mpStart = new Date(2026, 1, 28); // 28.02.2026
const mpEnd   = new Date(2026, 2, 8);  // 08.03.2026

/* ================= HELPERS ================= */
function debounce(fn, delay = 400) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}

async function saveDay(key, data) {
  await setDoc(doc(db, 'calendar', key), data, { merge: true });
}

async function loadDay(key) {
  const snap = await getDoc(doc(db, 'calendar', key));
  return snap.exists() ? snap.data() : {};
}

/* ================= LICZNIK GWIAZDEK ================= */
async function updateStarsCounter() {
  const today = new Date();
  today.setHours(0,0,0,0);

  let earned = 0;

  const docs = await getDocs(collection(db, 'calendar'));
  docs.forEach(d => {
    const [y, m, day] = d.id.split('-').map(Number);
    const date = new Date(y, m - 1, day);
    date.setHours(0,0,0,0);

    if (date >= today && date <= mpEnd) {
      earned += d.data().stars || 0;
    }
  });

  const daysLeft =
    Math.max(
      0,
      Math.floor((mpEnd - today) / (1000 * 60 * 60 * 24)) + 1
    );

  starsCounterEl.textContent = `‚≠ê Gwiazdki: ${earned}/${daysLeft * 5}`;
}

/* ================= COUNTDOWN ================= */
function updateCountdown() {
  const diff = Math.ceil((mpStart - new Date()) / (1000*60*60*24));
  countdownEl.textContent =
    diff > 0
      ? `‚è≥ Dni do Mistrzostw Polski: ${diff}`
      : `üèÜ Mistrzostwa trwajƒÖ lub zako≈Ñczone`;
}

/* ================= GWIAZDKI + IKONY ================= */
function createStarsIconsRow(key, data, container) {
  const row = document.createElement('div');
  row.className = 'stars-icons-row';

  const stars = document.createElement('div');
  stars.className = 'stars';

  for (let i = 1; i <= 5; i++) {
    const s = document.createElement('span');
    s.textContent = data.stars >= i ? '‚òÖ' : '‚òÜ';
    s.style.color = data.stars >= i ? 'gold' : 'black';

    s.onclick = async () => {
      data.stars = (data.stars === i) ? 0 : i;
      await saveDay(key, data);
      updateStarsCounter();
      if (currentView === 'month') renderMonth();
      if (currentView === 'day') renderDay(currentDate);
    };

    stars.appendChild(s);
  }

  const icons = document.createElement('div');
  icons.className = 'icons';
  const map = { trening:'üéØ', turniej:'üèÜ', analiza:'üß†', regeneracja:'üò¥' };

  Object.keys(map).forEach(f => {
    if (data[f]) {
      const i = document.createElement('span');
      i.textContent = map[f];
      icons.appendChild(i);
    }
  });

  row.append(stars, icons);
  container.appendChild(row);
}

/* ================= WIDOK DNIA ================= */
async function renderDay(date) {
  currentView = 'day';
  calendarEl.innerHTML = '';
  calendarEl.style.gridTemplateColumns = '1fr';

  const key = date.toISOString().slice(0,10);
  const data = await loadDay(key);

  titleEl.textContent =
    `Maja Matwiejczuk, KSz Bia≈Ço-Czarni Bolszewo ‚Äì ` +
    date.toLocaleDateString('pl-PL',{weekday:'long',day:'numeric',month:'long'});

  const dayEl = document.createElement('div');
  dayEl.className = 'day';

  dayEl.innerHTML = `
    <textarea class="big-text" placeholder="Plan dnia">${data.text||''}</textarea>
    <input class="text-input" placeholder="Link Lichess" value="${data.link||''}">
    <label class="trainer-check">
      <input type="checkbox" ${data.coachDone?'checked':''}>
      <span>Czy wykonano (informacje od trenera)</span>
    </label>
    <textarea class="medium-text" placeholder="Informacje od trenera">${data.coachInfo||''}</textarea>
  `;

  const [plan, coachInfo] = dayEl.querySelectorAll('textarea');
  const link = dayEl.querySelector('input');
  const coachCheck = dayEl.querySelector('input[type=checkbox]');

  const autosave = debounce(async () => {
    await saveDay(key, {
      ...data,
      text: plan.value,
      link: link.value,
      coachInfo: coachInfo.value,
      coachDone: coachCheck.checked
    });
  });

  plan.oninput = autosave;
  coachInfo.oninput = autosave;
  link.oninput = autosave;
  coachCheck.onchange = autosave;

  createStarsIconsRow(key, data, dayEl);
  calendarEl.appendChild(dayEl);
}

/* ================= MIESIƒÑC ================= */
async function renderMonth() {
  currentView = 'month';
  calendarEl.innerHTML = '';
  calendarEl.style.gridTemplateColumns = 'repeat(7,1fr)';

  const y = currentDate.getFullYear();
  const m = currentDate.getMonth();

  titleEl.textContent =
    `Maja Matwiejczuk, KSz Bia≈Ço-Czarni Bolszewo ‚Äì ` +
    currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});

  const first = new Date(y,m,1).getDay()||7;
  const days = new Date(y,m+1,0).getDate();

  for(let i=1;i<first;i++) calendarEl.appendChild(document.createElement('div'));

  for(let d=1;d<=days;d++){
    const date=new Date(y,m,d);
    const key=date.toISOString().slice(0,10);
    const data=await loadDay(key);

    const dayEl=document.createElement('div');
    dayEl.className='day';
    dayEl.ondblclick=()=>{ currentDate=date; renderDay(date); };

    dayEl.innerHTML=`<header>${d}</header><textarea>${data.text||''}</textarea>`;
    createStarsIconsRow(key,data,dayEl);
    calendarEl.appendChild(dayEl);
  }
}

/* ================= START ================= */
monthBtn.onclick = renderMonth;
dayBtn.onclick = () => renderDay(currentDate);
homeBtn.onclick = renderMonth;

window.onload = () => {
  updateCountdown();
  updateStarsCounter();
  renderMonth();
};
</script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; }
header.top { padding:10px; display:flex; justify-content:space-between; }
.views button { background:none; border:none; font-size:16px; cursor:pointer; }
.calendar { display:grid; gap:8px; padding:10px; }
.day {
  background:#fff;
  border-radius:8px;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.big-text { min-height:120px; }
.medium-text { min-height:80px; }
.text-input { height:34px; }
.trainer-check { display:flex; gap:8px; align-items:center; font-weight:bold; }
.stars-icons-row { display:flex; align-items:center; gap:12px; }
.stars span { cursor:pointer; font-size:20px; }
.icons span { font-size:18px; }
#countdown,#starsCounter { font-weight:bold; margin:6px 10px; display:inline-block; }
</style>
</head>

<body>
<header class="top">
  <h1 id="title">Kalendarz przygotowa≈Ñ</h1>
  <div class="views">
    <button id="homeBtn">Strona g≈Ç√≥wna</button>
    <button id="monthBtn">MiesiƒÖc</button>
    <button id="dayBtn">Dzie≈Ñ</button>
  </div>
</header>

<div id="countdown"></div>
<div id="starsCounter"></div>
<main id="calendar" class="calendar"></main>
</body>
</html>
