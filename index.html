<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kalendarz przygotowaÅ„ szachowych â€“ Maja Matwiejczuk</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCnMfYLnkVcttfpjcfisGv1s-Nx-pL4jFk",
  authDomain: "maja2026-2ee26.firebaseapp.com",
  projectId: "maja2026-2ee26",
  storageBucket: "maja2026-2ee26.firebasestorage.app",
  messagingSenderId: "365178420968",
  appId: "1:365178420968:web:2081cdd7ae556d6eb6135d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elementy DOM
const calendarEl = document.getElementById('calendar');
const titleEl = document.getElementById('title');
const monthBtn = document.getElementById('monthBtn');
const weekBtn = document.getElementById('weekBtn');
const dayBtn = document.getElementById('dayBtn');
const homeBtn = document.getElementById('homeBtn');
const countdownEl = document.getElementById('countdown');
const starsCounterEl = document.getElementById('starsCounter');

let currentDate = new Date();
const mpStart = new Date('2026-02-28');
const mpEnd = new Date('2026-03-08');
let tournamentDates = [
  { start: new Date('2025-12-28'), end: new Date('2025-12-29'), name: 'KoÅ„cÃ³wka Roku â€“ Malbork' },
  { start: mpStart, end: mpEnd, name: 'Mistrzostwa Polski 2026' }
];

let currentView = 'month'; // Å›ledzimy aktualny widok

function debounce(fn, delay=500){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }
async function saveDay(key, data){ await setDoc(doc(db,'calendar',key), data, {merge:true}); }
async function loadDay(key){ const snap = await getDoc(doc(db,'calendar',key)); return snap.exists()?snap.data():{}; }

// Licznik gwiazdek
async function updateStarsCounter(){
  const today = new Date();
  const allDocs = await getDocs(collection(db,'calendar'));
  let earned = 0; let total = 0;
  allDocs.forEach(doc=>{
    const d = new Date(doc.id);
    if(d>=today && d<=mpEnd){
      earned += doc.data().stars || 0;
      total += 5;
    }
  });
  starsCounterEl.textContent = `â­ Gwiazdki: ${earned}/${total}`;
}

// Countdown dni
function updateCountdown(){
  const today = new Date();
  const diff = Math.ceil((mpStart - today)/(1000*60*60*24));
  countdownEl.textContent = diff>0?`â³ Dni do Mistrzostw Polski: ${diff}`:`ğŸ† Mistrzostwa trwajÄ… lub zakoÅ„czone`;
}
setInterval(updateCountdown,60*1000);
setInterval(updateStarsCounter,2000);
updateCountdown(); updateStarsCounter();

// Gwiazdki
function createStars(key,data,container){
  const div = document.createElement('div'); 
  div.className='stars';
  div.style.display='flex'; 
  div.style.alignItems='center';
  for(let i=1;i<=5;i++){
    const s=document.createElement('span'); 
    s.innerHTML=(data.stars>=i)?'â˜…':'â˜†'; 
    s.style.color=(data.stars>=i)?'gold':'black';
    s.style.cursor='pointer';
    s.addEventListener('click', async()=>{
      data.stars=i; 
      await saveDay(key,data);
      updateStarsCounter();
      if(currentView==='month') renderMonth();
      if(currentView==='week') renderWeek();
      if(currentView==='day') renderDay(currentDate);
    });
    div.appendChild(s);
  }
  container.appendChild(div);
}

// Ikony z checkboxami (lewa strona)
function createIcons(key,data,container){
  const icons=[
    {label:'ğŸ¯',field:'trening'},
    {label:'ğŸ†',field:'turniej'},
    {label:'ğŸ§ ',field:'analiza'},
    {label:'ğŸ˜´',field:'regeneracja'}
  ];
  const div=document.createElement('div'); 
  div.className='icons'; 
  div.style.display='flex'; 
  div.style.alignItems='center'; 
  div.style.gap='4px';
  icons.forEach(ic=>{
    const span=document.createElement('span');
    const cb=document.createElement('input'); 
    cb.type='checkbox'; 
    cb.checked=data[ic.field]||false; 
    cb.style.marginRight='4px';
    cb.addEventListener('change',async(e)=>{ 
      data[ic.field]=e.target.checked; 
      await saveDay(key,data); 
      renderMonth(); 
    });
    span.appendChild(cb); 
    span.appendChild(document.createTextNode(ic.label)); 
    div.appendChild(span);
  });
  container.appendChild(div);
}

function isTournament(date){ return tournamentDates.find(t=>date>=t.start && date<=t.end); }

// Render miesiÄ…c
async function renderMonth(){
  currentView='month';
  calendarEl.innerHTML=''; 
  calendarEl.style.gridTemplateColumns='repeat(7,1fr)';
  const year=currentDate.getFullYear(); const month=currentDate.getMonth();
  titleEl.textContent=`Maja Matwiejczuk, KSz BiaÅ‚o-Czarni Bolszewo â€“ ${currentDate.toLocaleDateString('pl-PL',{month:'long',year:'numeric'})}`;
  const firstDay=new Date(year,month,1).getDay()||7;
  const daysInMonth=new Date(year,month+1,0).getDate();
  for(let i=1;i<firstDay;i++) calendarEl.appendChild(document.createElement('div'));

  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d); 
    const key=date.toISOString().slice(0,10);
    const data=await loadDay(key);
    const dayEl=document.createElement('div'); 
    dayEl.className='day'; 
    dayEl.style.height='150px';
    const t=isTournament(date); 
    if(date>=mpStart && date<=mpEnd) dayEl.classList.add('mp');
    if(t) dayEl.classList.add('tournament');

    dayEl.innerHTML=`<header>${d}${t? ' ğŸ† '+t.name : ''}</header>
      <textarea placeholder='Notatka'>${data.text||''}</textarea>`;

    const textarea=dayEl.querySelector('textarea');
    const autosave=debounce(async()=>{ await saveDay(key,{text:textarea.value,stars:data.stars,...data}); updateStarsCounter(); });
    textarea.addEventListener('input',autosave);

    dayEl.addEventListener('dblclick',()=>{ currentDate=date; renderDay(date); });
    createStars(key,data,dayEl);

    const iconsDiv=document.createElement('div'); iconsDiv.className='icons';
    iconsDiv.style.display='flex'; iconsDiv.style.gap='4px';
    ['trening','turniej','analiza','regeneracja'].forEach(f=>{
      if(data[f]){
        const span=document.createElement('span');
        span.textContent = {'trening':'ğŸ¯','turniej':'ğŸ†','analiza':'ğŸ§ ','regeneracja':'ğŸ˜´'}[f];
        iconsDiv.appendChild(span);
      }
    });
    dayEl.appendChild(iconsDiv);
    calendarEl.appendChild(dayEl);
  }
}

// Render tydzieÅ„
async function renderWeek(){
  currentView='week';
  calendarEl.innerHTML=''; calendarEl.style.gridTemplateColumns='repeat(7,1fr)';
  const dayOfWeek=(currentDate.getDay()||7)-1; 
  const monday=new Date(currentDate); 
  monday.setDate(currentDate.getDate()-dayOfWeek);
  titleEl.textContent=`Maja Matwiejczuk, KSz BiaÅ‚o-Czarni Bolszewo â€“ TydzieÅ„ od ${monday.toLocaleDateString('pl-PL')}`;

  for(let i=0;i<7;i++){
    const date=new Date(monday); date.setDate(monday.getDate()+i);
    const key=date.toISOString().slice(0,10);
    const data=await loadDay(key);
    const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.style.height='250px';
    const t=isTournament(date); if(t) dayEl.classList.add('tournament');
    dayEl.innerHTML=`<header>${date.toLocaleDateString('pl-PL',{ weekday:'short', day:'numeric'})}${t? ' ğŸ† '+t.name : ''}</header>
      <textarea placeholder='Notatka'>${data.text||''}</textarea>`;
    const textarea=dayEl.querySelector('textarea');
    const autosave=debounce(async()=>{ await saveDay(key,{text:textarea.value,stars:data.stars,...data}); updateStarsCounter(); });
    textarea.addEventListener('input',autosave);
    dayEl.addEventListener('dblclick',()=>{ currentDate=date; renderDay(date); });

    createStars(key,data,dayEl);
    const iconsDiv=document.createElement('div'); iconsDiv.className='icons';
    iconsDiv.style.display='flex'; iconsDiv.style.gap='4px';
    ['trening','turniej','analiza','regeneracja'].forEach(f=>{ if(data[f]){ const span=document.createElement('span'); span.textContent = {'trening':'ğŸ¯','turniej':'ğŸ†','analiza':'ğŸ§ ','regeneracja':'ğŸ˜´'}[f]; iconsDiv.appendChild(span); } });
    dayEl.appendChild(iconsDiv);
    calendarEl.appendChild(dayEl);
  }
}

// Render dnia peÅ‚nego
async function renderDay(date){
  currentView='day';
  calendarEl.innerHTML=''; 
  calendarEl.style.gridTemplateColumns='1fr';
  const key=date.toISOString().slice(0,10);
  const data=await loadDay(key);
  titleEl.textContent=`Maja Matwiejczuk, KSz BiaÅ‚o-Czarni Bolszewo â€“ ${date.toLocaleDateString('pl-PL',{ weekday:'long', day:'numeric', month:'long'})}`;

  const dayEl=document.createElement('div'); 
  dayEl.className='day'; 
  dayEl.style.height='500px';
  dayEl.style.display='flex';
  dayEl.style.flexDirection='column';
  dayEl.style.gap='8px';

  dayEl.innerHTML=`
    <textarea placeholder="Plan dnia" style="min-height:100px;">${data.text||''}</textarea>
    <input placeholder="Link Lichess" value="${data.link||''}" />
    <div style="display:flex; flex-direction:column; gap:4px;">
      <label>
        <input type="checkbox" id="coachCheck" ${data.coachDone?'checked':''}>
        Czy wykonano (Informacje od trenera)
      </label>
      <textarea placeholder="Informacje od trenera" style="min-height:80px;">${data.coachInfo||''}</textarea>
    </div>
    <small class='status'></small>
  `;

  const mainTextarea = dayEl.querySelectorAll('textarea')[0];
  const coachTextarea = dayEl.querySelectorAll('textarea')[1];
  const input=dayEl.querySelector('input');
  const coachCheckbox = dayEl.querySelector('#coachCheck');
  const status=dayEl.querySelector('small.status');

  const autosave=debounce(async()=>{
    status.textContent='â³ zapisywanieâ€¦';
    await saveDay(key,{
      text: mainTextarea.value,
      link: input.value,
      stars: data.stars,
      coachInfo: coachTextarea.value,
      coachDone: coachCheckbox.checked,
      ...data
    });
    status.textContent='âœ… zapisano';
    updateStarsCounter();
  });

  mainTextarea.addEventListener('input', autosave);
  input.addEventListener('input', autosave);
  coachTextarea.addEventListener('input', autosave);
  coachCheckbox.addEventListener('change', autosave);

  createStars(key,data,dayEl);
  createIcons(key,data,dayEl);
  calendarEl.appendChild(dayEl);
}



// Przycisk i eventy
monthBtn.onclick=()=>{ renderMonth(); }; 
weekBtn.onclick=()=>{ renderWeek(); }; 
dayBtn.onclick=()=>{ renderDay(currentDate); }; 
homeBtn.onclick=()=>{ renderMonth(); };

window.addEventListener('DOMContentLoaded',()=>renderMonth());
</script>

<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;}
header.top{padding:10px;display:flex;justify-content:space-between;align-items:center;}
.views button{margin:0 6px;background:none;border:none;color:#000;cursor:pointer;font-size:16px;}
.views button.active{font-weight:bold;text-decoration:underline;}
.calendar{display:grid;gap:8px;padding:10px;}
.day{background:#fff;border-radius:8px;padding:6px;box-shadow:0 0 4px rgba(0,0,0,.1);display:flex;flex-direction:column;justify-content:space-between;}
.day header{font-weight:bold;margin-bottom:4px;}
textarea,input{width:100%;margin-top:4px;}
textarea{min-height:80px;}
.mp{border:2px solid gold;}
.tournament{border:2px solid red;background:#fff0f0;}
#countdown,#starsCounter{padding:5px;font-weight:bold;display:inline-block;margin-right:15px;}
.stars span{cursor:pointer;font-size:20px;margin-right:2px;}
.icons span{margin-right:6px;font-size:18px; display:flex; align-items:center;}
</style>
</head>
<body>
<header class='top'>
<h1 id='title'>Kalendarz przygotowaÅ„</h1>
<div class='views'>
<button id='homeBtn'>Strona gÅ‚Ã³wna</button>
<button id='monthBtn' class='active'>MiesiÄ…c</button>
<button id='weekBtn'>TydzieÅ„</button>
<button id='dayBtn'>DzieÅ„</button>
</div>
</header>
<div id='countdown'></div><div id='starsCounter'></div>
<main id='calendar' class='calendar'></main>
</body>
</html>
