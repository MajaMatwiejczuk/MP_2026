<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Droga do MP â€“ Maja Matwiejczuk</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs, collection
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCnMfYLnkVcttfpjcfisGv1s-Nx-pL4jFk",
  authDomain: "maja2026-2ee26.firebaseapp.com",
  projectId: "maja2026-2ee26",
  storageBucket: "maja2026-2ee26.firebasestorage.app",
  messagingSenderId: "365178420968",
  appId: "1:365178420968:web:2081cdd7ae556d6eb6135d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== DATY ===== */
const mpStart = new Date(2026,1,28);
const mpEnd   = new Date(2026,2,8);

/* ===== TURNIEJE ===== */
const tournaments = [
  { name:"KoÅ„cÃ³wka Roku â€“ Malbork", start:"2025-12-28", end:"2025-12-29" },
  { name:"Mistrzostwa Polski", start:"2026-02-28", end:"2026-03-08" }
];

/* ===== DOM ===== */
const cal = document.getElementById("calendar");
const titleEl = document.getElementById("title");
const starsEl = document.getElementById("starsCounter");
const daysEl = document.getElementById("daysCounter");

/* ===== HELPERS ===== */
const iso = d => d.toISOString().slice(0,10);
const debounce = (f,t=400)=>{let x;return(...a)=>{clearTimeout(x);x=setTimeout(()=>f(...a),t)}};

async function loadDay(k){
  const s = await getDoc(doc(db,"calendar",k));
  return s.exists()?s.data():{};
}
async function saveDay(k,o){
  await setDoc(doc(db,"calendar",k),o,{merge:true});
}

/* ===== LICZNIKI ===== */
async function updateCounters(){
  const docs = await getDocs(collection(db,"calendar"));
  let stars=0;
  docs.forEach(d=>stars+=d.data().stars||0);

  const totalDays = Math.floor((mpEnd - new Date(2025,11,1))/(86400000))+1;
  starsEl.innerHTML = `â­ <b>${stars}</b> / ${totalDays*3}`;

  const diff = Math.ceil((mpStart-new Date())/86400000);
  daysEl.innerHTML = `ğŸ† <b>${diff}</b> dni do MP`;
}

/* ===== GWIAZDKI ===== */
function renderStars(k,data,el){
  const wrap=document.createElement("div");
  wrap.className="stars";
  for(let i=1;i<=3;i++){
    const s=document.createElement("span");
    s.textContent = data.stars>=i?"â˜…":"â˜†";
    s.onclick=async()=>{
      data.stars = data.stars===i?0:i;
      await saveDay(k,{stars:data.stars});
      s.parentNode.querySelectorAll("span").forEach((x,j)=>{
        x.textContent = data.stars>=j+1?"â˜…":"â˜†";
      });
      updateCounters();
      applyColors(el,data);
    };
    wrap.appendChild(s);
  }
  el.appendChild(wrap);
}

/* ===== CHECKLISTA ===== */
function renderChecklist(k,data,el){
  const list=document.createElement("div");
  list.className="checks";
  const map={trening:"ğŸ¯",turniej:"ğŸ†",analiza:"ğŸ§ ",regeneracja:"ğŸ˜´"};
  Object.keys(map).forEach(f=>{
    const l=document.createElement("label");
    const c=document.createElement("input");
    c.type="checkbox"; c.checked=data[f]||false;
    c.onchange=async()=>{
      await saveDay(k,{[f]:c.checked});
      if(f==="regeneracja") applyColors(el,{...data,[f]:c.checked});
    };
    l.append(c,map[f]);
    list.appendChild(l);
  });
  el.appendChild(list);
}

/* ===== KOLORY ===== */
function applyColors(el,data){
  el.classList.remove("no-stars","has-stars","regen","tournament");
  if(data.stars>0) el.classList.add("has-stars");
  else el.classList.add("no-stars");
  if(data.regeneracja) el.classList.add("regen");
  if(data.tournamentName) el.classList.add("tournament");
}

/* ===== MIESIÄ„C ===== */
async function renderMonth(date=new Date()){
  cal.innerHTML="";
  cal.className="month";
  titleEl.innerHTML=`Maja Matwiejczuk <img src="logo.png"> â€“ ${date.toLocaleDateString("pl-PL",{month:"long",year:"numeric"})}`;

  const y=date.getFullYear(), m=date.getMonth();
  const days=new Date(y,m+1,0).getDate();
  for(let d=1;d<=days;d++){
    const day=new Date(y,m,d);
    const k=iso(day);
    const data=await loadDay(k);

    tournaments.forEach(t=>{
      if(k>=t.start && k<=t.end){
        data.tournamentName=t.name;
        data.turniej=true;
      }
    });

    const el=document.createElement("div");
    el.className="day";
    el.innerHTML=`<b>${d}</b>
      ${data.tournamentName?`<div class="tname">${data.tournamentName}</div>`:""}
      <textarea rows="2">${data.text||""}</textarea>`;

    el.ondblclick=()=>renderDay(day);

    const ta=el.querySelector("textarea");
    ta.oninput=debounce(()=>saveDay(k,{text:ta.value}));

    renderStars(k,data,el);
    renderChecklist(k,data,el);
    applyColors(el,data);

    cal.appendChild(el);
  }
  updateCounters();
}

/* ===== DZIEÅƒ ===== */
async function renderDay(date){
  cal.innerHTML="";
  cal.className="dayview";
  const k=iso(date);
  const data=await loadDay(k);

  titleEl.textContent=`Maja Matwiejczuk â€“ ${date.toLocaleDateString("pl-PL",{weekday:"long",day:"numeric",month:"long"})}`;

  const el=document.createElement("div");
  el.className="day big";
  el.innerHTML=`
    <textarea rows="4">${data.text||""}</textarea>
    <input placeholder="Link Lichess" value="${data.link||""}">
  `;

  el.querySelector("textarea").oninput=debounce(e=>saveDay(k,{text:e.target.value}));
  el.querySelector("input").oninput=debounce(e=>saveDay(k,{link:e.target.value}));

  renderStars(k,data,el);
  renderChecklist(k,data,el);
  applyColors(el,data);

  cal.appendChild(el);
}

/* ===== START ===== */
window.onload=()=>renderMonth();
</script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0}
header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:2px solid #000}
header img{height:28px;margin-left:8px}
.menu button{margin:0 4px}
.counters{display:flex;justify-content:space-between;padding:8px;font-size:22px}
.legend{text-align:center;font-size:14px}
.calendar.month{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px}
.day{background:#fff;border:2px solid #000;border-radius:10px;padding:6px}
.day textarea{width:100%}
.stars span{font-size:22px;cursor:pointer;margin-right:2px}
.has-stars{background:#dff4ff}
.no-stars{background:#ffd6d6}
.regen{background:#6bd36b}
.tournament{background:#ffe066}
.tname{font-weight:bold}
.checks label{margin-right:6px}
.dayview{padding:10px}
.big textarea{width:100%}
</style>
</head>

<body>
<header>
  <h1 id="title">Droga do MP â€“ Maja Matwiejczuk</h1>
  <div class="menu">
    <button onclick="renderMonth()">ğŸ </button>
    <button>ğŸ“‹ Zadania</button>
    <button>ğŸ“Š Raport</button>
    <button>ğŸ† Turnieje</button>
  </div>
</header>

<div class="counters">
  <div id="starsCounter"></div>
  <div class="legend">ğŸ”´ brak â­ | ğŸ”µ trening | ğŸŸ¢ regeneracja | ğŸŸ¡ turniej</div>
  <div id="daysCounter"></div>
</div>

<main id="calendar"></main>
</body>
</html>
