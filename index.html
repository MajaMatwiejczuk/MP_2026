<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Kalendarz przygotowa≈Ñ ‚Äì Maja Matwiejczuk</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCnMfYLnkVcttfpjcfisGv1s-Nx-pL4jFk",
  authDomain: "maja2026-2ee26.firebaseapp.com",
  projectId: "maja2026-2ee26",
  storageBucket: "maja2026-2ee26.firebasestorage.app",
  messagingSenderId: "365178420968",
  appId: "1:365178420968:web:2081cdd7ae556d6eb6135d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM
const calendarEl = document.getElementById('calendar');
const titleEl = document.getElementById('title');
const monthBtn = document.getElementById('monthBtn');
const weekBtn = document.getElementById('weekBtn');
const dayBtn = document.getElementById('dayBtn');
const homeBtn = document.getElementById('homeBtn');
const monthSelect = document.getElementById('monthSelect');
const countdownEl = document.getElementById('countdown');
const starsCounterEl = document.getElementById('starsCounter');

let currentDate = new Date();
const mpStart = new Date('2026-02-28');
const mpEnd = new Date('2026-03-08');
let currentView='month';

function debounce(fn, delay=500){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }

async function saveDay(key, data){ await setDoc(doc(db,'calendar',key), data, {merge:true}); updateStarsCounter(); }
async function loadDay(key){ const snap = await getDoc(doc(db,'calendar',key)); return snap.exists()?snap.data():{}; }

async function updateStarsCounter(){
  const today = new Date();
  const allDocs = await getDocs(collection(db,'calendar'));
  let earned = 0; let total = 0;
  allDocs.forEach(doc=>{
    const d = new Date(doc.id);
    if(d>=today && d<=mpEnd){
      earned += doc.data().stars || 0;
      total += 5;
    }
  });
  starsCounterEl.textContent = `‚≠ê Gwiazdki: ${earned}/${total}`;
}

function updateCountdown(){
  const today = new Date();
  const diff = Math.ceil((mpStart - today)/(1000*60*60*24));
  countdownEl.textContent = diff>0?`‚è≥ Dni do Mistrzostw Polski: ${diff}`:`üèÜ Mistrzostwa trwajƒÖ lub zako≈Ñczone`;
}
setInterval(updateCountdown,60*1000);
updateCountdown();
updateStarsCounter();

function createStarsAndIcons(key,data,container){
  const wrapper = document.createElement('div');
  wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.justifyContent='space-between';

  const starsDiv = document.createElement('div');
  starsDiv.style.display='flex'; starsDiv.style.gap='2px';
  for(let i=1;i<=5;i++){
    const s=document.createElement('span'); s.innerHTML='‚òÜ'; s.style.cursor='pointer'; s.style.color='black';
    if(data.stars>=i){ s.innerHTML='‚òÖ'; s.style.color='gold'; }
    s.addEventListener('click',async(e)=>{
      e.stopPropagation(); data.stars=i; await saveDay(key,data); updateStarsCounter();
      if(currentView==='month') renderMonth();
      if(currentView==='week') renderWeek();
      if(currentView==='day' && currentDate.toISOString().slice(0,10)===key) renderDay(currentDate);
    });
    starsDiv.appendChild(s);
  }

  const iconsDiv = document.createElement('div');
  iconsDiv.style.display='flex'; iconsDiv.style.gap='4px';
  ['trening','turniej','analiza','regeneracja'].forEach(f=>{ if(data[f]){ const span=document.createElement('span'); span.textContent = {'trening':'üéØ','turniej':'üèÜ','analiza':'üß†','regeneracja':'üò¥'}[f]; iconsDiv.appendChild(span); } });

  wrapper.appendChild(starsDiv);
  wrapper.appendChild(iconsDiv);
  container.appendChild(wrapper);
}

async function renderDay(date){
  currentView='day';
  calendarEl.innerHTML=''; calendarEl.style.gridTemplateColumns='1fr';
  const key = date.toISOString().slice(0,10);
  const data = await loadDay(key);
  titleEl.textContent = `Maja Matwiejczuk, KSz Bia≈Ço-Czarni Bolszewo ‚Äì ${date.toLocaleDateString('pl-PL',{ weekday:'long', day:'numeric', month:'long'})}`;

  const dayEl=document.createElement('div'); dayEl.className='day'; dayEl.style.height='500px';
  dayEl.innerHTML=`
    <textarea placeholder="Plan dnia" style='height:120px;'>${data.text||''}</textarea>
    <textarea placeholder="Zadanie od trenera" style='height:80px;'>${data.task||''}</textarea>
    <label><input type='checkbox' ${data.taskDone?'checked':''}/> Czy wykonano</label>
    <input placeholder="Link Lichess" value="${data.link||''}" />
    <small class='status'></small>
  `;

  const textarea = dayEl.querySelectorAll('textarea')[0];
  const taskTextarea = dayEl.querySelectorAll('textarea')[1];
  const input = dayEl.querySelector('input[type=text],input[type=url]');
  const checkbox = dayEl.querySelector('input[type=checkbox]');
  const status = dayEl.querySelector('small.status');
  const autosave = debounce(async()=>{
    status.textContent='‚è≥ zapisywanie‚Ä¶';
    data.text = textarea.value; data.task = taskTextarea.value; data.taskDone = checkbox.checked; data.link = input.value;
    await saveDay(key,data);
    status.textContent='‚úÖ zapisano';
  });
  textarea.addEventListener('input',autosave);
  taskTextarea.addEventListener('input',autosave);
  input.addEventListener('input',autosave);
  checkbox.addEventListener('change',autosave);

  createStarsAndIcons(key,data,dayEl);
  calendarEl.appendChild(dayEl);
}

// Funkcje renderMonth() i renderWeek() nale≈ºy przywr√≥ciƒá dok≈Çadnie z dzia≈ÇajƒÖcej wersji poprzedniej
monthBtn.onclick=()=>{ currentView='month'; renderMonth(); };
weekBtn.onclick=()=>{ currentView='week'; renderWeek(); };
dayBtn.onclick=()=>{ renderDay(currentDate); };
homeBtn.onclick=()=>{ currentView='month'; renderMonth(); };
monthSelect.addEventListener('change',()=>{ currentDate.setMonth(parseInt(monthSelect.value)); renderMonth(); });
window.addEventListener('DOMContentLoaded',()=>renderMonth());
</script>

<style>
body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;}
header.top{padding:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
.views button{margin:0 6px;background:none;border:none;color:#000;cursor:pointer;font-size:16px;}
.views button.active{font-weight:bold;text-decoration:underline;}
#monthSelect{margin-left:10px;font-size:16px;}
.calendar{display:grid;gap:8px;padding:10px;}
.day{background:#fff;border-radius:8px;padding:6px;box-shadow:0 0 4px rgba(0,0,0,.1);display:flex;flex-direction:column;}
.day header{font-weight:bold;margin-bottom:4px;}
textarea,input{width:100%;margin-top:4px;}
textarea{min-height:50px;}
.mp{border:2px solid gold;}
.tournament{border:2px solid red;background:#fff0f0;}
#countdown,#starsCounter{padding:5px;font-weight:bold;display:inline-block;margin-right:15px;}
.stars span{cursor:pointer;font-size:20px;margin-right:2px;}
.icons span{margin-right:6px;font-size:18px;display:inline-block;}
</style>
</head>
<body>
<header class='top'>
<h1 id='title'>Kalendarz przygotowa≈Ñ</h1>
<div class='views'>
<button id='homeBtn'>Strona g≈Ç√≥wna</button>
<button id='monthBtn' class='active'>MiesiƒÖc</button>
<button id='weekBtn'>Tydzie≈Ñ</button>
<button id='dayBtn'>Dzie≈Ñ</button>
<select id='monthSelect'>
<option value='11'>Grudzie≈Ñ</option>
<option value='0'>Stycze≈Ñ</option>
<option value='1'>Luty</option>
</select>
</div>
</header>
<div id='countdown'></div><div id='starsCounter'></div>
<main id='calendar' class='calendar'></main>
</body>
</html>
